<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor | A2BA Music Group</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 font-family=%22Arial, sans-serif%22 font-weight=%22bold%22 fill=%22black%22>A</text></svg>">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f7f7f7; 
        }

        /* Loading Layar Penuh */
        .initial-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #ffffff; z-index: 9999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid #000000; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        .initial-loader p { font-size: 14px; font-weight: 600; color: #555555; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Layar Kunci Biometrik */
        .biometric-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #ffffff; z-index: 9998; 
            display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px;
        }
        .bio-icon { font-size: 60px; margin-bottom: 20px; }
        .bio-title { font-size: 20px; font-weight: bold; margin-bottom: 10px; }
        .bio-desc { font-size: 14px; color: #666; margin-bottom: 30px; max-width: 300px; }
        .btn-bio {
            background-color: #000; color: #fff; border: none; padding: 12px 30px; border-radius: 50px;
            font-weight: bold; cursor: pointer; transition: 0.3s;
        }
        .btn-bio:hover { background-color: #333; }

        /* Navbar */
        .navbar {
            background-color: #000000; color: #ffffff; padding: 15px 30px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .navbar-logo { height: 30px; object-fit: contain; filter: invert(1); }
        .btn-logout {
            background-color: transparent; border: 1px solid #ffffff; color: #ffffff;
            padding: 8px 20px; border-radius: 50px; cursor: pointer; font-size: 13px; font-weight: bold; transition: 0.2s;
        }
        .btn-logout:hover { background-color: #ffffff; color: #000000; }

        /* Konten Dasbor */
        .dashboard-container { max-width: 1000px; margin: 50px auto; padding: 0 20px; }
        .welcome-card { background-color: #ffffff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .welcome-card h1 { font-size: 24px; margin-bottom: 10px; color: #000000; }
        .welcome-card p { color: #555555; font-size: 15px; margin-bottom: 5px; }
        .user-email { font-weight: bold; color: #000000; }

        /* TOAST NOTIFIKASI */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff;
            text-align: center; border-radius: 50px; padding: 12px 20px;
            position: fixed; z-index: 99999; left: 50%; bottom: 30px;
            transform: translateX(-50%); font-size: 14px; font-weight: 500;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: visibility 0s, opacity 0.5s linear; opacity: 0;
        }
        #toast.show { visibility: visible; opacity: 1; }
    </style>
</head>
<body>

    <div id="initialLoader" class="initial-loader">
        <div class="spinner"></div>
        <p id="loaderText">Memuat Dasbor...</p>
    </div>

    <div id="biometricScreen" class="biometric-screen">
        <div class="bio-icon">üîê</div>
        <div class="bio-title">Keamanan Biometrik</div>
        <div class="bio-desc">Silakan verifikasi Sidik Jari atau Face ID Anda untuk mengakses Dasbor A2BA.</div>
        <button class="btn-bio" onclick="triggerBiometric()">VERIFIKASI SEKARANG</button>
        <button onclick="keluarDariBiometrik()" style="background:none; border:none; color:#e74c3c; font-weight:bold; margin-top:20px; cursor:pointer;">Batal & Logout</button>
    </div>

    <div id="dashboardContent" style="display: none;">
        <nav class="navbar">
            <img src="3128.png" alt="A2BA Logo" class="navbar-logo">
            <button id="btnLogout" class="btn-logout">LOGOUT</button>
        </nav>

        <div class="dashboard-container">
            <div class="welcome-card">
                <h1>Selamat Datang di A2BA Music Group</h1>
                <p>Status: <span style="color: #27ae60; font-weight: bold;">Terverifikasi ‚úÖ</span></p>
                <p>Login sebagai: <span id="userEmailDisplay" class="user-email">Memuat...</span></p>
                <br>
                <p style="font-size: 12px; color: #888;">* Sistem mungkin akan meminta izin akses Kamera, Notifikasi, dan Penyimpanan untuk fitur tertentu.</p>
            </div>
        </div>
    </div>

    <div id="toast">Tekan sekali lagi untuk keluar aplikasi</div>

    <script>
        const isApp = navigator.userAgent.toLowerCase().includes('a2ba') || navigator.userAgent.toLowerCase().includes('median') || navigator.userAgent.toLowerCase().includes('gonative');

        // --- 1. LOGIKA ANTI-BACK ---
        let doubleBackToExit = false;
        window.history.pushState(null, null, window.location.href);

        window.addEventListener('popstate', function(event) {
            if (!doubleBackToExit) {
                doubleBackToExit = true;
                const toast = document.getElementById('toast');
                toast.className = "show";
                window.history.pushState(null, null, window.location.href);
                setTimeout(function() {
                    toast.className = toast.className.replace("show", "");
                    doubleBackToExit = false;
                }, 2000);
            }
        });

        // --- 2. LOGIKA MEMINTA IZIN PWA ---
        function mintaIzinPWA() {
            if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                Notification.requestPermission();
            }
            if (navigator.storage && navigator.storage.persist) {
                navigator.storage.persist().then(granted => {
                    if(granted) console.log("Penyimpanan permanen diizinkan.");
                });
            }
        }

        // --- 3. JS BRIDGE BIOMETRIK ---
        window.medianBiometricCallback = function(response) {
            if (response && response.success) {
                // Sidik jari berhasil -> SIMPAN KE SESSION STORAGE agar tidak minta lagi selama app terbuka
                sessionStorage.setItem('biometricPassed', 'true');
                bukaDasborUtama();
            } else {
                alert("Verifikasi biometrik gagal atau dibatalkan. Pastikan perangkat Anda mendukung Face ID / Touch ID.");
            }
        };

        function triggerBiometric() {
            if(window.median && window.median.biometric && window.median.biometric.authenticate) {
                window.median.biometric.authenticate({ callback: 'medianBiometricCallback', reason: 'Akses Dasbor A2BA' });
            } else {
                window.location.href = 'median://biometric/authenticate?callback=medianBiometricCallback&reason=Akses%20Dasbor%20A2BA';
            }
        }

        function bukaDasborUtama() {
            document.getElementById('initialLoader').style.display = 'none';
            document.getElementById('biometricScreen').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';
            setTimeout(() => { mintaIzinPWA(); }, 1500);
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCVSvYDeBdQb7dT1YrQhLPRIDb12DcyF-I",
            authDomain: "aldotune-5dfd0.firebaseapp.com",
            databaseURL: "https://aldotune-5dfd0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "aldotune-5dfd0",
            storageBucket: "aldotune-5dfd0.firebasestorage.app",
            messagingSenderId: "271598081160",
            appId: "1:271598081160:web:30c803c825421f90597b3d",
            measurementId: "G-LYV2T35KPT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        const initialLoader = document.getElementById('initialLoader');
        const userEmailDisplay = document.getElementById('userEmailDisplay');
        const btnLogout = document.getElementById('btnLogout');

        window.keluarDariBiometrik = function() {
            sessionStorage.removeItem('biometricPassed'); // Bersihkan sesi biometrik
            signOut(auth).then(() => {
                window.location.replace('login.html');
            });
        };

        // LOGIKA PENJAGA PINTU DASBOR
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.replace('login.html'); 
            } else if (!user.emailVerified) {
                window.location.replace('verifikasi.html');
            } else {
                userEmailDisplay.innerText = user.email;

                // Cek apakah pakai Aplikasi Median
                if (isApp) {
                    // Cek apakah di sesi ini user sudah pernah scan biometrik
                    if (sessionStorage.getItem('biometricPassed') === 'true') {
                        // Jika sudah lolos, langsung masuk tanpa scan lagi
                        bukaDasborUtama();
                    } else {
                        // Jika belum lolos / baru buka app, paksa scan
                        initialLoader.style.display = 'none';
                        document.getElementById('biometricScreen').style.display = 'flex';
                        triggerBiometric();
                    }
                } else {
                    // Web browser biasa tidak perlu biometrik
                    bukaDasborUtama();
                }
            }
        });

        // FUNGSI LOGOUT DARI DASBOR
        btnLogout.addEventListener('click', () => {
            btnLogout.innerText = "Keluar...";
            sessionStorage.removeItem('biometricPassed'); // Wajib hapus sesi biometrik saat logout
            signOut(auth).then(() => {
                window.location.replace('login.html');
            }).catch((error) => {
                alert("Gagal logout: " + error.message);
                btnLogout.innerText = "LOGOUT";
            });
        });
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js');
            });
        }
    </script>

</body>
</html>