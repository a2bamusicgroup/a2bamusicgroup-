<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | A2BA Music Group</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 font-family=%22Arial, sans-serif%22 font-weight=%22bold%22 fill=%22black%22>A</text></svg>">

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">

    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

    <style>
        /* Reset Dasar */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #ffffff; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            min-height: 100vh; 
        }

        /* Loading Awal */
        .initial-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #ffffff; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid #000000; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        .initial-loader p { font-size: 14px; font-weight: 600; color: #555555; letter-spacing: 0.5px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Container Utama */
        .login-wrapper {
            width: 100%; max-width: 400px; padding: 0 20px 40px 20px; 
            margin-top: 0; text-align: center;
        }
        .logo-container { margin-top: 40px; margin-bottom: 30px; }
        .logo-container img { height: 55px; object-fit: contain; }

        /* Tombol Umum */
        .btn {
            border: none; border-radius: 50px; padding: 14px 0; width: 100%; 
            font-size: 14px; font-weight: bold; letter-spacing: 1px; transition: 0.3s;
            display: flex; justify-content: center; align-items: center; gap: 10px;
        }

        /* Tombol Google */
        .btn-google { 
            background-color: #ffffff; color: #555555; 
            border: 2px solid #eeeeee; box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            cursor: not-allowed; opacity: 0.6; margin-bottom: 10px;
        }
        .btn-google.active { color: #333333; border-color: #dddddd; opacity: 1; cursor: pointer; }
        .btn-google.active:hover { background-color: #f9f9f9; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .google-icon { width: 18px; height: 18px; filter: grayscale(100%); transition: 0.3s; }
        .btn-google.active .google-icon { filter: grayscale(0%); }

        /* Garis Pemisah */
        .divider {
            display: flex; align-items: center; text-align: center; margin: 25px 0; 
            color: #aaaaaa; font-size: 11px; font-weight: bold; letter-spacing: 1px;
        }
        .divider::before, .divider::after {
            content: ''; flex: 1; border-bottom: 1px solid #eeeeee; margin: 0 15px;
        }

        /* Form Input */
        .input-group { margin-bottom: 20px; text-align: left; position: relative; }
        .input-group label {
            display: block; font-size: 12px; color: #555555;
            text-transform: uppercase; letter-spacing: 0.5px; font-weight: bold; margin-bottom: 8px; 
        }
        .input-group input {
            width: 100%; background-color: #f7f7f7; border: none;
            border-bottom: 2px solid #dddddd; border-radius: 4px 4px 0 0;
            font-size: 15px; color: #000000; font-family: inherit; font-weight: 500;
            padding: 15px; outline: none; transition: 0.2s;
        }
        .input-group input[type="password"], .input-group input.password-visible { padding-right: 45px; }
        .input-group input:focus { border-bottom-color: #000000; background-color: #f0f0f0; }
        .input-group input:-webkit-autofill {
            -webkit-box-shadow: 0 0 0 30px #f0f0f0 inset !important;
            -webkit-text-fill-color: #000000 !important; border-radius: 4px 4px 0 0;
        }

        /* Ikon Mata */
        .toggle-password {
            position: absolute; right: 15px; bottom: 12px; background: none; border: none;
            cursor: pointer; color: #888888; display: flex; align-items: center; justify-content: center;
            padding: 0; transition: 0.2s;
        }
        .toggle-password:hover { color: #000000; }
        .toggle-password svg { width: 20px; height: 20px; fill: currentColor; }

        /* Cloudflare Turnstile */
        .turnstile-container {
            margin-top: 10px; margin-bottom: 25px; display: flex; flex-direction: column;
            align-items: center; min-height: 80px; 
        }
        .cf-status-text { font-size: 12px; font-weight: bold; color: #e67e22; margin-top: 10px; transition: 0.3s; }
        .cf-status-text.success { color: #27ae60; }

        /* Tombol Login Biasa */
        .btn-login { background-color: #cccccc; color: #ffffff; cursor: not-allowed; margin-bottom: 15px; }
        .btn-login.active { background-color: #000000; cursor: pointer; }
        .btn-login.active:hover { background-color: #333333; }

        /* Link Bawah */
        .link-container { margin-top: 20px; display: flex; flex-direction: column; gap: 15px; }
        .link-text { color: #000000; font-size: 13px; font-weight: 500; text-decoration: none; transition: 0.2s; }
        .link-text:hover { color: #666666; text-decoration: underline; }

        /* Modal Umum */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 99999; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-box { background: #fff; padding: 30px; border-radius: 8px; max-width: 400px; width: 100%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-icon { font-size: 2.5rem; margin-bottom: 10px; }
        .modal-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; color: #000; }
        .modal-desc { font-size: 0.9rem; color: #555; margin-bottom: 20px; line-height: 1.5; }
        .btn-modal-action { display: block; width: 100%; padding: 12px; border-radius: 4px; font-weight: bold; margin-bottom: 10px; text-decoration: none; cursor: pointer; border: none; font-size: 14px; transition: 0.2s; }
        .btn-black { background: #000; color: #fff; }
        .btn-black:hover { background: #333; }
        .btn-outline { background: #f0f0f0; color: #333; border: 1px solid #ddd; }
        .btn-outline:hover { background: #e0e0e0; }
    </style>
</head>
<body>

    <div id="initialLoader" class="initial-loader">
        <div class="spinner"></div>
        <p id="loaderText">Memeriksa keamanan & sesi...</p>
    </div>

    <div class="login-wrapper">
        <div class="logo-container">
            <img src="3128.png" alt="A2BA Logo">
        </div>

        <button type="button" id="btnGoogle" class="btn btn-google" disabled>
            <svg class="google-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
            </svg>
            Google Login & Daftar
        </button>

        <div class="divider">ATAU GUNAKAN EMAIL</div>

        <form id="loginForm" autocomplete="off">
            <input type="email" style="display:none" name="fakeemail">
            <input type="password" style="display:none" name="fakepassword">

            <div class="input-group">
                <label for="email">Email</label>
                <input type="email" id="email" autocomplete="username" required>
            </div>

            <div class="input-group">
                <label for="password">Password</label>
                <input type="password" id="password" autocomplete="current-password" required>
                <button type="button" class="toggle-password" id="btnTogglePassword" onclick="togglePasswordVisibility()">
                    <svg id="eyeIcon" viewBox="0 0 24 24"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>
                </button>
            </div>

            <div class="turnstile-container">
                <div id="my-turnstile" class="cf-turnstile" 
                     data-sitekey="0x4AAAAAACf2lK9vDKOHkazJ" 
                     data-callback="turnstileSukses"
                     data-expired-callback="turnstileReset"
                     data-error-callback="turnstileReset">
                </div>
                <div id="cf-status" class="cf-status-text">‚è≥ Sedang memverifikasi keamanan...</div>
            </div>

            <div class="button-container">
                <button type="submit" id="btnLogin" class="btn btn-login" disabled>LOGIN</button>
            </div>

            <div class="link-container">
                <a href="reset.html" class="link-text">Lupa password Anda?</a>
                <a href="#" class="link-text" onclick="bukaModalDaftar(event)">Belum punya akun? Daftar Manual</a>
            </div>
        </form>

    </div>

    <div id="alertModal" class="modal-overlay">
        <div class="modal-box">
            <div id="alertIcon" class="modal-icon">‚ö†Ô∏è</div>
            <div id="alertTitle" class="modal-title">Peringatan</div>
            <div id="alertDesc" class="modal-desc">Pesan peringatan di sini.</div>
            <button class="btn-modal-action btn-black" onclick="tutupModal('alertModal')">Mengerti</button>
        </div>
    </div>

    <div id="daftarModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-icon">üé∏</div>
            <div class="modal-title">Daftar Akun Artis</div>
            <div class="modal-desc">Saat ini, pendaftaran akun baru melalui email manual harus dilakukan via Admin untuk proses verifikasi data musisi.<br><br>Gunakan tombol <strong>Google Login & Daftar</strong> di atas jika Anda ingin mendaftar otomatis, atau hubungi Admin kami.</div>
            <button class="btn-modal-action btn-black" onclick="tutupModal('daftarModal')">Mengerti</button>
        </div>
    </div>

    <div id="installModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-icon">üì≤</div>
            <div class="modal-title">Instal Aplikasi A2BA</div>
            <div class="modal-desc">Tambahkan A2BA Music Group ke layar utama perangkat Anda untuk akses yang lebih cepat dan mudah.</div>
            <button id="btnInstallConfirm" class="btn-modal-action btn-black">Instal Sekarang</button>
            <button class="btn-modal-action btn-outline" onclick="tutupModal('installModal')">Nanti Saja</button>
        </div>
    </div>

    <script>
        // Cek Deteksi Aplikasi Bawaan A2BA / Median
        const isApp = navigator.userAgent.toLowerCase().includes('a2ba') || navigator.userAgent.toLowerCase().includes('median') || navigator.userAgent.toLowerCase().includes('gonative');

        function tampilkanAlert(judul, pesan, ikon = '‚ö†Ô∏è') {
            document.getElementById('alertTitle').innerText = judul;
            document.getElementById('alertDesc').innerText = pesan;
            document.getElementById('alertIcon').innerText = ikon;
            document.getElementById('alertModal').style.display = 'flex';
        }

        function tutupModal(idModal) { document.getElementById(idModal).style.display = 'none'; }
        function bukaModalDaftar(event) { event.preventDefault(); document.getElementById('daftarModal').style.display = 'flex'; }

        function togglePasswordVisibility() {
            var passwordInput = document.getElementById("password");
            var eyeIcon = document.getElementById("eyeIcon");
            if (passwordInput.type === "password") {
                passwordInput.type = "text";
                passwordInput.classList.add('password-visible');
                eyeIcon.innerHTML = '<path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>';
            } else {
                passwordInput.type = "password";
                passwordInput.classList.remove('password-visible');
                eyeIcon.innerHTML = '<path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>';
            }
        }

        function turnstileSukses() {
            var statusText = document.getElementById('cf-status');
            var btnLogin = document.getElementById('btnLogin');
            var btnGoogle = document.getElementById('btnGoogle');
            statusText.innerText = "‚úÖ Keamanan terverifikasi";
            statusText.classList.add('success');
            btnLogin.removeAttribute('disabled'); btnLogin.classList.add('active');
            btnGoogle.removeAttribute('disabled'); btnGoogle.classList.add('active');
        }

        function turnstileReset() {
            var statusText = document.getElementById('cf-status');
            var btnLogin = document.getElementById('btnLogin');
            var btnGoogle = document.getElementById('btnGoogle');
            statusText.innerText = "‚è≥ Memverifikasi ulang keamanan...";
            statusText.classList.remove('success');
            btnLogin.disabled = true; btnLogin.classList.remove('active');
            btnGoogle.disabled = true; btnGoogle.classList.remove('active');
            if (typeof turnstile !== 'undefined') { turnstile.reset(); }
        }
    </script>

    <script type="module">
        // Tambahan import signInWithCredential untuk menerima token dari Median JS Bridge
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signInWithCredential } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCVSvYDeBdQb7dT1YrQhLPRIDb12DcyF-I",
            authDomain: "aldotune-5dfd0.firebaseapp.com",
            databaseURL: "https://aldotune-5dfd0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "aldotune-5dfd0",
            storageBucket: "aldotune-5dfd0.firebasestorage.app",
            messagingSenderId: "271598081160",
            appId: "1:271598081160:web:30c803c825421f90597b3d",
            measurementId: "G-LYV2T35KPT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        const initialLoader = document.getElementById('initialLoader');
        const loaderText = document.getElementById('loaderText');

        // CEK SESI AWAL
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loaderText.innerText = "Mengalihkan...";
                if (user.emailVerified) {
                    window.location.replace('rmh.html');
                } else {
                    window.location.replace('verifikasi.html');
                }
            } else {
                initialLoader.style.opacity = '0';
                setTimeout(() => { initialLoader.style.display = 'none'; }, 500);
            }
        });

        // SUBMIT LOGIN EMAIL BIASA
        document.getElementById('loginForm').addEventListener('submit', function(event) {
            event.preventDefault(); 
            var turnstileResponse = document.querySelector('[name="cf-turnstile-response"]');
            if (!turnstileResponse || turnstileResponse.value === "") {
                tampilkanAlert("Akses Ditolak", "Verifikasi keamanan Cloudflare belum selesai!", "üõ°Ô∏è");
                return;
            }

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btnLogin = document.getElementById('btnLogin');

            btnLogin.innerText = "MEMPROSES...";
            btnLogin.style.cursor = "wait";

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    if (userCredential.user.emailVerified) {
                        window.location.replace('rmh.html');
                    } else {
                        window.location.replace('verifikasi.html');
                    }
                })
                .catch((error) => {
                    btnLogin.innerText = "LOGIN";
                    btnLogin.style.cursor = "pointer";
                    if(error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                        tampilkanAlert("Gagal Login", "Email atau Password salah.", "‚ùå");
                    } else if (error.code === 'auth/too-many-requests') {
                        tampilkanAlert("Akun Dikunci", "Terlalu banyak percobaan gagal. Coba lagi nanti.", "üîí");
                    } else if (error.code === 'auth/user-disabled') {
                        tampilkanAlert("Akun Dinonaktifkan", "Akun Anda telah dinonaktifkan oleh Admin.", "üö´");
                    } else {
                        tampilkanAlert("Kesalahan Sistem", "Terjadi kesalahan: " + error.message, "‚ö†Ô∏è");
                    }
                });
        });

        // ----------------------------------------------------
        // LOGIN GOOGLE (WEB POPUP & MEDIAN NATIVE APP BRIDGE)
        // ----------------------------------------------------
        const btnGoogle = document.getElementById('btnGoogle');
        const googleProvider = new GoogleAuthProvider();

        // 1. Fungsi Penerima (Callback) untuk JS Bridge Median
        window.medianGoogleCallback = function(response) {
            if (response && response.idToken) {
                const credential = GoogleAuthProvider.credential(response.idToken);
                
                signInWithCredential(auth, credential)
                    .then((result) => {
                        window.location.replace('rmh.html');
                    })
                    .catch((error) => {
                        kembalikanTombolGoogle();
                        tampilkanAlert("Gagal Login Native", "Terjadi kesalahan: " + error.message, "‚ö†Ô∏è");
                    });
            } else {
                kembalikanTombolGoogle();
                // Jika user membatalkan jendela login native
                if(response && response.error) {
                    console.log("Login native dibatalkan: " + response.error);
                }
            }
        };

        function kembalikanTombolGoogle() {
            btnGoogle.innerHTML = `<svg class="google-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg> Google Login & Daftar`;
        }

        // 2. Event Listener Tombol Google
        btnGoogle.addEventListener('click', () => {
            if(btnGoogle.disabled) {
                tampilkanAlert("Akses Ditolak", "Silakan selesaikan verifikasi keamanan Cloudflare terlebih dahulu.", "üõ°Ô∏è");
                return;
            }

            btnGoogle.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; margin-bottom: 0; border-width: 2px;"></div>';
            
            // A. JIKA DIAKSES DARI APLIKASI MEDIAN NATIVE
            if (isApp) {
                // Perintah untuk memicu SDK Native Google di Android/iOS Median
                if(window.median && window.median.socialLogin && window.median.socialLogin.google) {
                    window.median.socialLogin.google.login({ callback: 'medianGoogleCallback' });
                } else {
                    window.location.href = 'median://socialLogin/google/login?callback=medianGoogleCallback';
                }
            } 
            // B. JIKA DIAKSES DARI WEB BROWSER BIASA
            else {
                signInWithPopup(auth, googleProvider)
                    .then((result) => {
                        window.location.replace('rmh.html'); 
                    })
                    .catch((error) => {
                        kembalikanTombolGoogle();
                        if (error.code !== 'auth/popup-closed-by-user') {
                            tampilkanAlert("Gagal Login Google", "Terjadi kesalahan: " + error.message, "‚ö†Ô∏è");
                        }
                    });
            }
        });
    </script>

    <script>
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            // JANGAN tampilkan modal sama sekali jika dibuka dari dalam aplikasi Native
            if (isApp) return;

            deferredPrompt = e;
            document.getElementById('installModal').style.display = 'flex';
        });

        document.getElementById('btnInstallConfirm').addEventListener('click', () => {
            window.location.replace('instal.html');
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js');
            });
        }
    </script>

</body>
</html>